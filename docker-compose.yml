version: "3.9"

services:
  # Redis: Хранилище данных и брокер сообщений
  redis:
    image: redis:7.2.4-alpine
    container_name: redis-newsbot-${APP_VERSION}
    restart: unless-stopped
    command: >
      redis-server 
      --logfile /var/log/redis/redis.log 
      --loglevel ${REDIS_LOG_LEVEL:-notice}
      --stop-writes-on-bgsave-error no
    ports:
      - "6379:6379"
    volumes:
      - ./logs_docker_images/redis:/var/log/redis
      - ./redis_data:/data
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: '0.5'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Основной API сервис (FastAPI)
  # Все Python-сервисы используют один общий образ newsbot-app для экономии ресурсов
  web:
    build: .
    image: newsbot-app:${APP_VERSION}
    container_name: web-newsbot-api-${APP_VERSION}
    restart: unless-stopped
    env_file:
      - .env
    depends_on:
      - redis
    ports:
      - "8000:8000"
    volumes:
      - ./logs_docker_images/web:/app/logs
    command: uvicorn main:app --host 0.0.0.0 --port 8000
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Celery Worker: Обработка задач (скрапинг, ИИ)
  worker:
    image: newsbot-app:${APP_VERSION}
    container_name: worker-newsbot-${APP_VERSION}
    restart: unless-stopped
    env_file:
      - .env
    depends_on:
      - redis
    volumes:
      - ./logs_docker_images/worker:/app/logs
    command: celery -A app.tasks:celery_app worker --loglevel=info
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.8'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Celery Beat: Планировщик задач
  beat:
    image: newsbot-app:${APP_VERSION}
    container_name: beat-newsbot-${APP_VERSION}
    restart: unless-stopped
    env_file:
      - .env
    depends_on:
      - redis
    volumes:
      - ./logs_docker_images/beat:/app/logs
    command: celery -A app.tasks:celery_app beat --loglevel=info
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: '0.2'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Telegram Bot: Интерактивное взаимодействие
  bot:
    image: newsbot-app:${APP_VERSION}
    container_name: bot-newsbot-interactive-${APP_VERSION}
    restart: unless-stopped
    env_file:
      - .env
    depends_on:
      - redis
    volumes:
      - ./logs_docker_images/bot:/app/logs
    command: python app/telegram/run_bot.py
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# Сеть по умолчанию для всех сервисов
networks:
  default:
    driver: bridge