version: "3.9"

services:
  # Redis: Хранилище данных и брокер сообщений
  redis:
    image: redis:7.2.4-alpine
    container_name: redis-tecnonews-${APP_VERSION}
    restart: unless-stopped
    command: >
      redis-server
      --appendonly yes
      --appendfsync everysec
      --auto-aof-rewrite-percentage 100
      --auto-aof-rewrite-min-size 64mb
      --loglevel ${REDIS_LOG_LEVEL:-notice}
      --stop-writes-on-bgsave-error no
    ports:
      - "6379:6379"
    volumes:
      - ./redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: '0.5'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Основной API сервис (FastAPI)
  web:
    build:
      context: .
      args:
        APP_VERSION: ${APP_VERSION}
    image: tecnonews/web-app:${APP_VERSION}
    container_name: web-tecnonews-fastapi-${APP_VERSION}
    restart: unless-stopped
    env_file:
      - .env
    depends_on:
      redis:
        condition: service_healthy
    ports:
      - "8000:8000"
    volumes:
      - ./logs_docker_images/web:/app/logs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/"]
      interval: 30s
      timeout: 10s
      retries: 3
    command: ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000", "--workers", "1"]
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Celery Worker: Обработка задач (скрапинг, ИИ)
  worker:
    build:
      context: .
      args:
        APP_VERSION: ${APP_VERSION}
    image: tecnonews/worker-app:${APP_VERSION}
    container_name: worker-tecnonews-${APP_VERSION}
    restart: unless-stopped
    env_file:
      - .env
    depends_on:
      redis:
        condition: service_healthy
      web:
        condition: service_healthy
    volumes:
      - ./logs_docker_images/worker:/app/logs
    command: ["celery", "-A", "app.tasks:celery_app", "worker", "--loglevel=info", "--concurrency=2", "-n", "worker1@%h"]
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.8'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Celery Beat: Планировщик задач
  beat:
    build:
      context: .
      args:
        APP_VERSION: ${APP_VERSION}
    image: tecnonews/beat-app:${APP_VERSION}
    container_name: beat-tecnonews-${APP_VERSION}
    restart: unless-stopped
    env_file:
      - .env
    depends_on:
      redis:
        condition: service_healthy
    volumes:
      - ./logs_docker_images/beat:/app/logs
    command: ["celery", "-A", "app.tasks:celery_app", "beat", "--loglevel=info"]
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: '0.2'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Telegram Bot: Интерактивное взаимодействие
  bot:
    build:
      context: .
      args:
        APP_VERSION: ${APP_VERSION}
    image: tecnonews/newsbot-app:${APP_VERSION}
    container_name: bot-tecnonews-interactive-${APP_VERSION}
    restart: unless-stopped
    env_file:
      - .env
    depends_on:
      redis:
        condition: service_healthy
    volumes:
      - ./logs_docker_images/bot:/app/logs
    command: ["python", "app/telegram/run_bot.py"]
    init: true
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# Сеть по умолчанию для всех сервисов
networks:
  default:
    driver: bridge

